<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard</title>    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="admin-styles.css">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
</head>
<body>
    <div class="admin-container">
        <div id="loginSection">
            <div class="login-form">
                <div class="logo">
                    <img src="admin-page.jpg" alt="Admin Logo" style="height:64px;width:auto;display:block;margin:0 auto;border-radius:16px;border:1px solid #222;">
                    <h1>Admin Dashboard</h1>
                </div>
                <form id="adminLoginForm">
                    <div class="form-group">
                        <label for="adminUsername">Username</label>
                        <input type="text" id="adminUsername" name="adminUsername" required>
                    </div>
                    <div class="form-group">
                        <label for="adminPassword">Password</label>
                        <input type="password" id="adminPassword" name="adminPassword" required>
                    </div>
                    <button type="submit" class="btn-primary">
                        <i class="fas fa-sign-in-alt"></i>
                        Đăng nhập
                    </button>
                </form>
            </div>
        </div>

        <div id="dashboardSection" style="display: none;">
            <div class="admin-header">
                <h1><i class="fas fa-tachometer-alt"></i> Dashboard</h1>
                <button id="logoutBtn" class="btn-secondary">
                    <i class="fas fa-sign-out-alt"></i>
                    Đăng xuất
                </button>
            </div>            <div class="admin-actions">
                <button id="exportBtn" class="btn-primary">
                    <i class="fas fa-file-excel"></i>
                    Xuất Excel
                </button>
                <button id="exportPptxBtn" class="btn-primary">
                    <i class="fas fa-file-powerpoint"></i>
                    Xuất PowerPoint
                </button>
                <button id="refreshBtn" class="btn-secondary">
                    <i class="fas fa-sync-alt"></i>
                    Làm mới
                </button>                <button id="templateManagementBtn" class="btn-success">
                    <i class="fas fa-cogs"></i>
                    Quản lý Template
                </button>
                <button id="userManagementBtn" class="btn-success">
                    <i class="fas fa-users"></i>
                    Quản lý User
                </button>
            </div><div class="filter-row">
                <input type="text" id="filterUsername" placeholder="Lọc theo username" class="filter-input">
                <input type="text" id="filterTdsName" placeholder="Lọc theo TDS name" class="filter-input">
                <input type="text" id="filterStore" placeholder="Lọc theo cửa hàng" class="filter-input">
                <input type="text" id="filterCategory" placeholder="Lọc theo danh mục" class="filter-input">
                <button id="applyFilterBtn" class="btn-secondary">
                    <i class="fas fa-filter"></i>
                    Lọc
                </button>
            </div>
              <div class="filter-row">
                <div class="date-filter-container">
                    <label for="filterStartDate">Từ ngày:</label>
                    <input type="date" id="filterStartDate" class="filter-input">
                </div>
                <div class="date-filter-container">
                    <label for="filterEndDate">Đến ngày:</label>
                    <input type="date" id="filterEndDate" class="filter-input">
                </div>
                <button id="resetFilterBtn" class="btn-secondary">
                    <i class="fas fa-times"></i>
                    Xóa bộ lọc
                </button>            </div>

            <!-- Multi-delete controls -->
            <div class="multi-select-controls" id="multiSelectControls" style="display: none;">
                <div class="selected-count">
                    <span id="selectedCount">0</span> mục đã chọn
                </div>
                <div class="multi-actions">
                    <button id="selectAllBtn" class="btn-secondary">
                        <i class="fas fa-check-square"></i>
                        Chọn tất cả
                    </button>
                    <button id="deselectAllBtn" class="btn-secondary">
                        <i class="fas fa-square"></i>
                        Bỏ chọn tất cả
                    </button>
                    <button id="deleteSelectedBtn" class="btn-danger">
                        <i class="fas fa-trash"></i>
                        Xóa đã chọn
                    </button>
                </div>            </div>

            <!-- Template Management Modal -->
            <div id="templateModal" class="modal" style="display: none;">
                <div class="modal-content template-modal">
                    <div class="modal-header">
                        <h2><i class="fas fa-cogs"></i> Quản lý Template</h2>
                        <span class="close" id="closeTemplateModal">&times;</span>
                    </div>
                    <div class="modal-body">
                        <div class="template-tabs">
                            <button class="tab-button active" data-tab="stores">Cửa hàng</button>
                            <button class="tab-button" data-tab="categories">Danh mục</button>
                            <button class="tab-button" data-tab="mcp">MCP</button>
                        </div>
                        
                        <!-- Stores Tab -->
                        <div id="storesTab" class="tab-content active">
                            <div class="upload-section">
                                <h3><i class="fas fa-upload"></i> Upload Template Cửa hàng</h3>
                                <div class="file-upload-area">
                                    <input type="file" id="storesFileInput" accept=".xlsx" style="display: none;">
                                    <div class="upload-dropzone" id="storesDropzone">
                                        <i class="fas fa-cloud-upload-alt"></i>
                                        <p>Kéo thả file Excel hoặc click để chọn</p>
                                        <small>Chỉ chấp nhận file .xlsx</small>
                                    </div>
                                    <button id="uploadStoresBtn" class="btn-primary" disabled>
                                        <i class="fas fa-upload"></i>
                                        Upload Stores
                                    </button>
                                </div>
                            </div>                            <div class="template-info">
                                <h4>Format yêu cầu:</h4>
                                <p>File Excel cần có các cột: <strong>stt, tdlName, tdsName, promoterName, typeShop, headcountInvest, headcountActive, seniority, storeName, storeCode, dealerCode, address, storeType, channel, keyCities, nearestKeyCity, rankingCommune, base, shopTier, region, province, city, district</strong></p>
                                <a href="/api/template/stores-sample" class="btn-secondary">
                                    <i class="fas fa-download"></i>
                                    Tải dữ liệu hiện tại
                                </a>
                                <small style="display: block; margin-top: 5px; color: #666;">Tải về file Excel chứa toàn bộ dữ liệu cửa hàng hiện tại</small>
                            </div>
                        </div>
                        
                        <!-- Categories Tab -->
                        <div id="categoriesTab" class="tab-content">                            <div class="upload-section">
                                <h3><i class="fas fa-upload"></i> Upload Template Danh mục</h3>
                                <div class="file-upload-area">
                                    <input type="file" id="categoriesFileInput" accept=".xlsx" style="display: none;">
                                    <div class="upload-dropzone" id="categoriesDropzone">
                                        <i class="fas fa-cloud-upload-alt"></i>
                                        <p>Kéo thả file Excel hoặc click để chọn</p>
                                        <small>Chỉ chấp nhận file .xlsx</small>
                                    </div>
                                    <button id="uploadCategoriesBtn" class="btn-primary" disabled>
                                        <i class="fas fa-upload"></i>
                                        Upload Categories
                                    </button>
                                </div>
                            </div>                            <div class="template-info">
                                <h4>Format yêu cầu:</h4>
                                <p>File Excel cần có các cột: <strong>id, name, description, isActive, order</strong></p>
                                <a href="/api/template/categories-sample" class="btn-secondary">
                                    <i class="fas fa-download"></i>
                                    Tải dữ liệu hiện tại
                                </a>
                                <small style="display: block; margin-top: 5px; color: #666;">Tải về file Excel chứa toàn bộ dữ liệu danh mục hiện tại</small>
                            </div>
                        </div>
                        
                        <!-- MCP Tab -->
                        <div id="mcpTab" class="tab-content">
                            <div class="upload-section">
                                <h3><i class="fas fa-upload"></i> Upload Template MCP (Visit Plan)</h3>
                                <div class="file-upload-area">
                                    <input type="file" id="mcpFileInput" accept=".xlsx" style="display: none;">
                                    <div class="upload-dropzone" id="mcpDropzone">
                                        <i class="fas fa-cloud-upload-alt"></i>
                                        <p>Kéo thả file Excel hoặc click để chọn</p>
                                        <small>Chỉ chấp nhận file .xlsx</small>
                                    </div>
                                    <button id="uploadMcpBtn" class="btn-primary" disabled>
                                        <i class="fas fa-upload"></i>
                                        Upload MCP
                                    </button>
                                </div>
                            </div>
                            <div class="template-info">
                                <h4>Format yêu cầu:</h4>
                                <p>File Excel cần có các cột: <strong>username, storeCode, Date, Value</strong></p>
                                <a href="/api/template/mcp-sample" class="btn-secondary" id="exportMcpBtn">
                                    <i class="fas fa-download"></i>
                                    Tải dữ liệu MCP hiện tại
                                </a>
                                <small style="display: block; margin-top: 5px; color: #666;">Tải về file Excel chứa toàn bộ dữ liệu MCP (visit plan) hiện tại</small>
                            </div>
                        </div>
                        
                        <div class="upload-progress" id="uploadProgress" style="display: none;">
                            <div class="progress-bar">
                                <div class="progress-fill" id="progressFill"></div>
                            </div>
                            <p id="progressText">Đang xử lý...</p>
                        </div>                    </div>
                </div>
            </div>

            <!-- User Management Modal -->
            <div id="userModal" class="modal" style="display: none;">
                <div class="modal-content user-modal">
                    <div class="modal-header">
                        <h2><i class="fas fa-users"></i> Quản lý User</h2>
                        <span class="close" id="closeUserModal">&times;</span>
                    </div>
                    <div class="modal-body">                        <div class="user-actions">
                            <button id="addUserBtn" class="btn-primary">
                                <i class="fas fa-user-plus"></i>
                                Thêm User Mới
                            </button>
                            <button id="exportUsersBtn" class="btn-success">
                                <i class="fas fa-download"></i>
                                Xuất dữ liệu Users
                            </button>
                            <button id="refreshUsersBtn" class="btn-secondary">
                                <i class="fas fa-sync-alt"></i>
                                Làm mới
                            </button>
                            <input type="file" id="importUsersFileInput" accept=".xlsx" style="display:none;">
                            <button id="importUsersBtn" class="btn-primary">
                                <i class="fas fa-upload"></i>
                                Import Users
                            </button>
                        </div>
                        
                        <div id="importUsersProgress" class="upload-progress" style="display:none; margin-bottom:10px;">
                            <div class="progress-bar">
                                <div class="progress-fill" id="importUsersProgressFill"></div>
                            </div>
                            <p id="importUsersProgressText">Đang xử lý...</p>
                        </div>
                        
                        <div class="users-table-container">
                            <table class="users-table">
                                <thead>                                    <tr>
                                        <th>Username</th>
                                        <th>User ID</th>
                                        <th>Role</th>
                                        <th>Trạng thái</th>
                                        <th>Ngày tạo</th>
                                        <th>Thao tác</th>
                                    </tr>
                                </thead>
                                <tbody id="usersTableBody">
                                    <!-- Users will be loaded here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- User Form Modal -->
            <div id="userFormModal" class="modal" style="display: none;">
                <div class="modal-content user-form-modal">
                    <div class="modal-header">
                        <h2 id="userFormTitle"><i class="fas fa-user-edit"></i> Thêm User Mới</h2>
                        <span class="close" id="closeUserFormModal">&times;</span>
                    </div>
                    <div class="modal-body">
                        <form id="userForm">
                            <input type="hidden" id="editUserId" name="editUserId">
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="userUsername">Username <span class="required">*</span></label>
                                    <input type="text" id="userUsername" name="username" required>
                                </div>
                                <div class="form-group">
                                    <label for="userUserId">User ID <span class="required">*</span></label>
                                    <input type="text" id="userUserId" name="userId" required>
                                </div>
                            </div>
                              <div class="form-row">
                                <div class="form-group">
                                    <label for="userRole">Role <span class="required">*</span></label>
                                    <select id="userRole" name="role" required>
                                        <option value="">Chọn Role</option>
                                        <option value="Admin">Admin</option>
                                        <option value="TDL">TDL</option>
                                        <option value="TDS">TDS</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="userPassword">Password <span class="required">*</span></label>
                                    <input type="password" id="userPassword" name="password" required>
                                </div>
                            </div>
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="userStatus">Trạng thái</label>
                                    <select id="userStatus" name="status">
                                        <option value="active">Hoạt động</option>
                                        <option value="inactive">Không hoạt động</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div class="form-actions">
                                <button type="button" id="cancelUserForm" class="btn-secondary">
                                    <i class="fas fa-times"></i>
                                    Hủy
                                </button>
                                <button type="submit" class="btn-primary">
                                    <i class="fas fa-save"></i>
                                    Lưu
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <table class="admin-table">
                <thead>                    <tr>
                        <th>
                            <input type="checkbox" id="selectAllCheckbox" title="Chọn tất cả">
                        </th>
                        <th>Username</th>
                        <th>TDS name</th>
                        <th>Cửa hàng</th>
                        <th>Danh mục</th>
                        <th>Thời gian</th>
                        <th>Hình ảnh</th>
                        <th>Thao tác</th>
                    </tr>
                </thead>
                <tbody id="submissionsTableBody">
                    <!-- Submissions will be loaded here -->
                </tbody>
            </table>

            <div class="pagination" id="paginationContainer">
                <!-- Pagination buttons will be added here -->
            </div>
        </div>
    </div>

    <!-- Image Preview Modal -->
    <div id="imagePreviewModal" class="image-preview-modal">
        <div class="modal-content">
            <button class="modal-close" id="closeModal">
                <i class="fas fa-times"></i>
            </button>
            <h2 id="modalTitle">Chi tiết kết quả</h2>
            <p id="modalInfo"></p>
            <p id="modalNote"></p>
            <div class="image-grid" id="modalImageGrid">
                <!-- Images will be added here -->
            </div>
        </div>
    </div>

    <!-- Loading overlay -->
    <div id="loadingOverlay" class="loading-overlay">
        <div class="loading-spinner"></div>
        <p>Đang xử lý...</p>
    </div>    <!-- Toast notifications -->
    <div id="toast" class="toast"></div>

    <!-- Image Lightbox Modal -->
    <div id="imageLightbox" class="image-lightbox">
        <div class="lightbox-content">
            <button class="lightbox-close" id="closeLightbox">
                <i class="fas fa-times"></i>
            </button>
            <button class="lightbox-prev" id="prevImage">
                <i class="fas fa-chevron-left"></i>
            </button>
            <button class="lightbox-next" id="nextImage">
                <i class="fas fa-chevron-right"></i>
            </button>
            <img id="lightboxImage" src="" alt="Lightbox Image">
            <div class="lightbox-counter">
                <span id="currentImageIndex">1</span> / <span id="totalImages">1</span>
            </div>
        </div>
    </div>

    <script>
        // Admin Dashboard JavaScript
        document.addEventListener('DOMContentLoaded', function() {
            // Elements
            const loginSection = document.getElementById('loginSection');
            const dashboardSection = document.getElementById('dashboardSection');
            const adminLoginForm = document.getElementById('adminLoginForm');
            const logoutBtn = document.getElementById('logoutBtn');            const exportBtn = document.getElementById('exportBtn');
            const exportPptxBtn = document.getElementById('exportPptxBtn');            const refreshBtn = document.getElementById('refreshBtn');
            const templateManagementBtn = document.getElementById('templateManagementBtn');
            const userManagementBtn = document.getElementById('userManagementBtn');
            const submissionsTableBody = document.getElementById('submissionsTableBody');
            const paginationContainer = document.getElementById('paginationContainer');
            const imagePreviewModal = document.getElementById('imagePreviewModal');
            const closeModal = document.getElementById('closeModal');
            const modalTitle = document.getElementById('modalTitle');
            const modalInfo = document.getElementById('modalInfo');
            const modalNote = document.getElementById('modalNote');
            const modalImageGrid = document.getElementById('modalImageGrid');
            
            // Template management elements
            const templateModal = document.getElementById('templateModal');
            const closeTemplateModal = document.getElementById('closeTemplateModal');
            const tabButtons = document.querySelectorAll('.tab-button');
            const tabContents = document.querySelectorAll('.tab-content');
            const storesFileInput = document.getElementById('storesFileInput');
            const categoriesFileInput = document.getElementById('categoriesFileInput');
            const storesDropzone = document.getElementById('storesDropzone');
            const categoriesDropzone = document.getElementById('categoriesDropzone');
            const uploadStoresBtn = document.getElementById('uploadStoresBtn');
            const uploadCategoriesBtn = document.getElementById('uploadCategoriesBtn');            const uploadProgress = document.getElementById('uploadProgress');
            const progressFill = document.getElementById('progressFill');
            const progressText = document.getElementById('progressText');
            
            // User management elements
            const userModal = document.getElementById('userModal');
            const closeUserModal = document.getElementById('closeUserModal');
            const userFormModal = document.getElementById('userFormModal');
            const closeUserFormModal = document.getElementById('closeUserFormModal');            const addUserBtn = document.getElementById('addUserBtn');
            const exportUsersBtn = document.getElementById('exportUsersBtn');
            const refreshUsersBtn = document.getElementById('refreshUsersBtn');
            const usersTableBody = document.getElementById('usersTableBody');
            const userForm = document.getElementById('userForm');
            const userFormTitle = document.getElementById('userFormTitle');
            const cancelUserForm = document.getElementById('cancelUserForm');
            
            // Lightbox elements
            const imageLightbox = document.getElementById('imageLightbox');
            const closeLightbox = document.getElementById('closeLightbox');
            const prevImage = document.getElementById('prevImage');
            const nextImage = document.getElementById('nextImage');
            const lightboxImage = document.getElementById('lightboxImage');
            const currentImageIndex = document.getElementById('currentImageIndex');
            const totalImages = document.getElementById('totalImages');            const filterUsername = document.getElementById('filterUsername');
            const filterTdsName = document.getElementById('filterTdsName');
            const filterStore = document.getElementById('filterStore');
            const filterCategory = document.getElementById('filterCategory');
            const filterStartDate = document.getElementById('filterStartDate');
            const filterEndDate = document.getElementById('filterEndDate');            const applyFilterBtn = document.getElementById('applyFilterBtn');
            const resetFilterBtn = document.getElementById('resetFilterBtn');

            // Multi-select elements
            const multiSelectControls = document.getElementById('multiSelectControls');
            const selectAllCheckbox = document.getElementById('selectAllCheckbox');
            const selectAllBtn = document.getElementById('selectAllBtn');
            const deselectAllBtn = document.getElementById('deselectAllBtn');
            const deleteSelectedBtn = document.getElementById('deleteSelectedBtn');
            const selectedCount = document.getElementById('selectedCount');            // Variables
            let submissions = [];
            let selectedSubmissions = new Set(); // Track selected submission IDs
            let currentPage = 1;            let itemsPerPage = 10;
            let selectedStoresFile = null;
            let selectedCategoriesFile = null;
            let users = [];            let editingUserId = null;
            let isExporting = false; // Flag to prevent multiple exports
            let isExportingPptx = false; // Flag to prevent multiple PPTX exports
            let filters = {
                username: '',
                tdsName: '',
                store: '',
                category: '',
                startDate: '',
                endDate: ''
            };
            
            // Lightbox variables
            let currentLightboxImages = [];
            let currentLightboxIndex = 0;
            
            // Check if already logged in
            checkAdminSession();
              // Event Listeners
            adminLoginForm.addEventListener('submit', handleAdminLogin);            logoutBtn.addEventListener('click', handleLogout);
            exportBtn.addEventListener('click', handleExport);            exportPptxBtn.addEventListener('click', handleExportPptx);            refreshBtn.addEventListener('click', loadSubmissions);
            templateManagementBtn.addEventListener('click', openTemplateModal);
            userManagementBtn.addEventListener('click', openUserModal);
            closeModal.addEventListener('click', () => imagePreviewModal.style.display = 'none');
            
            // Lightbox event listeners
            closeLightbox.addEventListener('click', closeLightboxModal);
            prevImage.addEventListener('click', showPreviousImage);
            nextImage.addEventListener('click', showNextImage);
            
            // Close lightbox on background click
            imageLightbox.addEventListener('click', (e) => {
                if (e.target === imageLightbox) {
                    closeLightboxModal();
                }
            });
            
            // Keyboard navigation for lightbox
            document.addEventListener('keydown', (e) => {
                if (imageLightbox.style.display === 'block') {
                    if (e.key === 'Escape') {
                        closeLightboxModal();
                    } else if (e.key === 'ArrowLeft') {
                        showPreviousImage();
                    } else if (e.key === 'ArrowRight') {
                        showNextImage();
                    }
                }
            });            applyFilterBtn.addEventListener('click', applyFilters);
            resetFilterBtn.addEventListener('click', resetFilters);

            // Multi-select event listeners
            if (selectAllCheckbox) {
                selectAllCheckbox.addEventListener('change', handleSelectAllCheckbox);
            }
            if (selectAllBtn) {
                selectAllBtn.addEventListener('click', selectAllSubmissions);
            }
            if (deselectAllBtn) {
                deselectAllBtn.addEventListener('click', deselectAllSubmissions);
            }            if (deleteSelectedBtn) {
                deleteSelectedBtn.addEventListener('click', deleteSelectedSubmissions);
            }
            
            // Template management event listeners
            if (closeTemplateModal) {
                closeTemplateModal.addEventListener('click', closeTemplateModalHandler);
            }
            
            // Tab switching
            tabButtons.forEach(button => {
                button.addEventListener('click', () => {
                    const tabName = button.getAttribute('data-tab');
                    switchTab(tabName);
                });
            });
            
            // File input handlers
            if (storesFileInput) {
                storesFileInput.addEventListener('change', (e) => handleFileSelect(e, 'stores'));
            }
            if (categoriesFileInput) {
                categoriesFileInput.addEventListener('change', (e) => handleFileSelect(e, 'categories'));
            }
            
            // Dropzone handlers
            if (storesDropzone) {
                setupDropzone(storesDropzone, storesFileInput, 'stores');
            }
            if (categoriesDropzone) {
                setupDropzone(categoriesDropzone, categoriesFileInput, 'categories');
            }
            
            // Upload button handlers
            if (uploadStoresBtn) {
                uploadStoresBtn.addEventListener('click', () => uploadTemplate('stores'));
            }
            if (uploadCategoriesBtn) {
                uploadCategoriesBtn.addEventListener('click', () => uploadTemplate('categories'));
            }
              // Close modal on background click
            if (templateModal) {
                templateModal.addEventListener('click', (e) => {
                    if (e.target === templateModal) {
                        closeTemplateModalHandler();
                    }
                });
            }
            
            // User management event listeners
            if (closeUserModal) {
                closeUserModal.addEventListener('click', closeUserModalHandler);
            }
            if (closeUserFormModal) {
                closeUserFormModal.addEventListener('click', closeUserFormModalHandler);
            }
            if (addUserBtn) {
                addUserBtn.addEventListener('click', () => openUserForm());
            }            if (refreshUsersBtn) {
                refreshUsersBtn.addEventListener('click', loadUsers);
            }
            if (exportUsersBtn) {
                exportUsersBtn.addEventListener('click', () => {
                    window.open('/api/template/users-sample', '_blank');
                });
            }
            // Import Users logic đã được xử lý trong script.js
            if (userForm) {
                userForm.addEventListener('submit', handleUserFormSubmit);
            }
            if (cancelUserForm) {
                cancelUserForm.addEventListener('click', closeUserFormModalHandler);
            }
            
            // Close user modals on background click
            if (userModal) {
                userModal.addEventListener('click', (e) => {
                    if (e.target === userModal) {
                        closeUserModalHandler();
                    }
                });
            }
            if (userFormModal) {
                userFormModal.addEventListener('click', (e) => {
                    if (e.target === userFormModal) {
                        closeUserFormModalHandler();
                    }
                });
            }
            
            // Functions
            function showLoading(show = true) {
                document.getElementById('loadingOverlay').classList.toggle('active', show);
            }

            function showToast(message, type = 'info') {
                const toast = document.getElementById('toast');
                toast.textContent = message;
                toast.className = `toast show ${type}`;
                setTimeout(() => {
                    toast.classList.remove('show');
                }, 3000);
            }
            
            async function checkAdminSession() {
                try {
                    const response = await fetch('/api/admin/check-session', {
                        credentials: 'same-origin'
                    });
                    
                    if (response.ok) {
                        // User is already logged in as admin
                        loginSection.style.display = 'none';
                        dashboardSection.style.display = 'block';
                        loadSubmissions();
                    }
                } catch (error) {
                    console.error('Session check error:', error);
                }
            }
              async function handleAdminLogin(e) {
                e.preventDefault();
                showLoading(true);
                
                const username = document.getElementById('adminUsername').value;
                const password = document.getElementById('adminPassword').value;
                
                try {
                    // Log in via the API with the entered credentials
                    const response = await fetch('/api/login', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ username: username, password: password }),
                        credentials: 'same-origin'
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        
                        // Check if the user is actually an admin
                        if (data.user && data.user.role === 'Admin') {
                            loginSection.style.display = 'none';
                            dashboardSection.style.display = 'block';
                            loadSubmissions();
                            showToast('Đăng nhập thành công!', 'success');
                        } else {
                            showToast('Tài khoản không có quyền truy cập admin.', 'error');
                        }
                    } else {
                        const error = await response.json();
                        showToast(error.error || 'Đăng nhập thất bại. Vui lòng kiểm tra lại thông tin đăng nhập.', 'error');
                    }
                } catch (error) {
                    console.error('Login error:', error);
                    showToast('Lỗi kết nối', 'error');
                }
                
                showLoading(false);
            }
            
            async function handleLogout() {
                showLoading(true);
                
                try {
                    await fetch('/api/logout', { 
                        method: 'POST',
                        credentials: 'same-origin'
                    });
                    
                    loginSection.style.display = 'block';
                    dashboardSection.style.display = 'none';
                    showToast('Đã đăng xuất', 'success');
                } catch (error) {
                    console.error('Logout error:', error);
                    showToast('Lỗi đăng xuất', 'error');
                }
                
                showLoading(false);
            }              async function loadSubmissions() {
                showLoading(true);
                  try {
                    const queryParams = new URLSearchParams({
                        username: filters.username,
                        tdsName: filters.tdsName,
                        store: filters.store,
                        category: filters.category,
                        startDate: filters.startDate,
                        endDate: filters.endDate
                    });
                    
                    const response = await fetch('/api/admin/submissions?' + queryParams, {
                        credentials: 'same-origin'
                    });
                    
                    if (response.ok) {
                        submissions = await response.json();
                        renderSubmissions();
                        showToast('Đã tải dữ liệu', 'success');
                    } else {
                        showToast('Không thể tải dữ liệu', 'error');
                    }
                } catch (error) {
                    console.error('Load submissions error:', error);
                    showToast('Lỗi kết nối', 'error');
                }
                
                showLoading(false);
            }
              function renderSubmissions() {
                submissionsTableBody.innerHTML = '';
                
                // Clear selected submissions when rendering new data
                selectedSubmissions.clear();
                updateMultiSelectControls();
                  if (submissions.length === 0) {
                    submissionsTableBody.innerHTML = `
                        <tr>
                            <td colspan="8" style="text-align: center; padding: 30px;">
                                <i class="fas fa-info-circle"></i> Không có dữ liệu nào
                            </td>
                        </tr>
                    `;
                    paginationContainer.innerHTML = '';
                    return;
                }
                
                // Calculate pagination
                const totalPages = Math.ceil(submissions.length / itemsPerPage);
                const startIndex = (currentPage - 1) * itemsPerPage;
                const endIndex = Math.min(startIndex + itemsPerPage, submissions.length);
                const paginatedSubmissions = submissions.slice(startIndex, endIndex);                  // Render submissions
                paginatedSubmissions.forEach(submission => {
                    // Format date as DD-MM-YYYY HH:MM:SS
                    const date = new Date(submission.submittedAt);
                    const formattedDate = `${String(date.getDate()).padStart(2, '0')}-${String(date.getMonth() + 1).padStart(2, '0')}-${date.getFullYear()} ${String(date.getHours()).padStart(2, '0')}:${String(date.getMinutes()).padStart(2, '0')}:${String(date.getSeconds()).padStart(2, '0')}`;
                    const imageCount = submission.images ? submission.images.length : 0;
                    
                    const row = document.createElement('tr');                    row.innerHTML = `
                        <td>
                            <input type="checkbox" class="row-checkbox" data-id="${submission._id}">
                        </td>
                        <td>${submission.username || 'N/A'}</td>
                        <td>${submission.tdsName || 'N/A'}</td>
                        <td>${submission.storeName || 'N/A'}</td>
                        <td>${submission.categoryName || 'N/A'}</td>
                        <td>${formattedDate}</td>
                        <td>${imageCount} ảnh</td>
                        <td class="actions">
                            <button class="btn-action btn-view" data-id="${submission._id}">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="btn-action btn-delete" data-id="${submission._id}">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    `;
                    
                    submissionsTableBody.appendChild(row);
                });
                  // Add event listeners
                document.querySelectorAll('.btn-view').forEach(btn => {
                    btn.addEventListener('click', () => viewSubmission(btn.getAttribute('data-id')));
                });
                
                document.querySelectorAll('.btn-delete').forEach(btn => {
                    btn.addEventListener('click', () => deleteSubmission(btn.getAttribute('data-id')));
                });

                // Add checkbox event listeners
                document.querySelectorAll('.row-checkbox').forEach(checkbox => {
                    checkbox.addEventListener('change', handleRowCheckboxChange);
                });
                
                // Render pagination
                renderPagination(totalPages);
            }
            
            function renderPagination(totalPages) {
                paginationContainer.innerHTML = '';
                
                if (totalPages <= 1) return;
                
                // Previous button
                const prevBtn = document.createElement('button');
                prevBtn.innerHTML = '<i class="fas fa-chevron-left"></i>';
                prevBtn.disabled = currentPage === 1;
                prevBtn.addEventListener('click', () => {
                    if (currentPage > 1) {
                        currentPage--;
                        renderSubmissions();
                    }
                });
                paginationContainer.appendChild(prevBtn);
                
                // Page buttons
                for (let i = 1; i <= totalPages; i++) {
                    const pageBtn = document.createElement('button');
                    pageBtn.textContent = i;
                    pageBtn.classList.toggle('active', i === currentPage);
                    pageBtn.addEventListener('click', () => {
                        currentPage = i;
                        renderSubmissions();
                    });
                    paginationContainer.appendChild(pageBtn);
                }
                
                // Next button
                const nextBtn = document.createElement('button');
                nextBtn.innerHTML = '<i class="fas fa-chevron-right"></i>';
                nextBtn.disabled = currentPage === totalPages;
                nextBtn.addEventListener('click', () => {
                    if (currentPage < totalPages) {
                        currentPage++;
                        renderSubmissions();
                    }
                });
                paginationContainer.appendChild(nextBtn);
            }
            
            function viewSubmission(id) {
                const submission = submissions.find(s => s._id === id);
                if (!submission) return;
                  modalTitle.textContent = `${submission.storeName} - ${submission.categoryName}`;
                
                // Format date for modal display
                const modalDate = new Date(submission.submittedAt);
                const modalFormattedDate = `${String(modalDate.getDate()).padStart(2, '0')}-${String(modalDate.getMonth() + 1).padStart(2, '0')}-${modalDate.getFullYear()} ${String(modalDate.getHours()).padStart(2, '0')}:${String(modalDate.getMinutes()).padStart(2, '0')}:${String(modalDate.getSeconds()).padStart(2, '0')}`;
                
                modalInfo.textContent = `Người dùng: ${submission.username} | Thời gian: ${modalFormattedDate}`;
                modalNote.textContent = `Ghi chú: ${submission.note || 'Không có'}`;
                  modalImageGrid.innerHTML = '';
                if (submission.images && submission.images.length > 0) {
                    submission.images.forEach((imageUrl, index) => {
                        const imageItem = document.createElement('div');
                        imageItem.className = 'image-item';
                        imageItem.innerHTML = `<img src="${imageUrl}" alt="Ảnh ${index + 1}">`;
                        
                        // Add click event to open lightbox
                        imageItem.addEventListener('click', () => {
                            openLightbox(submission.images, index);
                        });
                        
                        modalImageGrid.appendChild(imageItem);
                    });
                } else {
                    modalImageGrid.innerHTML = '<p>Không có hình ảnh</p>';
                }
                
                imagePreviewModal.style.display = 'block';
            }
            
            async function deleteSubmission(id) {
                if (!confirm('Bạn có chắc chắn muốn xóa kết quả này?')) return;
                
                showLoading(true);
                
                try {
                    const response = await fetch(`/api/admin/submissions/${id}`, {
                        method: 'DELETE',
                        credentials: 'same-origin'
                    });
                    
                    if (response.ok) {
                        // Remove from the local array
                        submissions = submissions.filter(s => s._id !== id);
                        renderSubmissions();
                        showToast('Đã xóa kết quả', 'success');
                    } else {
                        showToast('Không thể xóa kết quả', 'error');
                    }                } catch (error) {
                    console.error('Delete error:', error);
                    showToast('Lỗi kết nối', 'error');
                }
                
                showLoading(false);
            }

            // Multi-select functions
            function handleRowCheckboxChange(event) {
                const checkbox = event.target;
                const submissionId = checkbox.getAttribute('data-id');
                
                if (checkbox.checked) {
                    selectedSubmissions.add(submissionId);
                } else {
                    selectedSubmissions.delete(submissionId);
                }
                
                updateMultiSelectControls();
            }

            function handleSelectAllCheckbox(event) {
                const isChecked = event.target.checked;
                const rowCheckboxes = document.querySelectorAll('.row-checkbox');
                
                rowCheckboxes.forEach(checkbox => {
                    checkbox.checked = isChecked;
                    const submissionId = checkbox.getAttribute('data-id');
                    
                    if (isChecked) {
                        selectedSubmissions.add(submissionId);
                    } else {
                        selectedSubmissions.delete(submissionId);
                    }
                });
                
                updateMultiSelectControls();
            }

            function selectAllSubmissions() {
                const rowCheckboxes = document.querySelectorAll('.row-checkbox');
                rowCheckboxes.forEach(checkbox => {
                    checkbox.checked = true;
                    const submissionId = checkbox.getAttribute('data-id');
                    selectedSubmissions.add(submissionId);
                });
                
                // Update master checkbox
                const selectAllCheckbox = document.getElementById('selectAllCheckbox');
                if (selectAllCheckbox) {
                    selectAllCheckbox.checked = true;
                }
                
                updateMultiSelectControls();
            }

            function deselectAllSubmissions() {
                const rowCheckboxes = document.querySelectorAll('.row-checkbox');
                rowCheckboxes.forEach(checkbox => {
                    checkbox.checked = false;
                    const submissionId = checkbox.getAttribute('data-id');
                    selectedSubmissions.delete(submissionId);
                });
                
                // Update master checkbox
                const selectAllCheckbox = document.getElementById('selectAllCheckbox');
                if (selectAllCheckbox) {
                    selectAllCheckbox.checked = false;
                }
                
                updateMultiSelectControls();
            }

            function updateMultiSelectControls() {
                const selectedCount = selectedSubmissions.size;
                const multiSelectControls = document.getElementById('multiSelectControls');
                const selectedCountElement = document.getElementById('selectedCount');
                
                if (selectedCount > 0) {
                    multiSelectControls.style.display = 'flex';
                    selectedCountElement.textContent = selectedCount;
                } else {
                    multiSelectControls.style.display = 'none';
                }

                // Update master checkbox state
                const selectAllCheckbox = document.getElementById('selectAllCheckbox');
                const rowCheckboxes = document.querySelectorAll('.row-checkbox');
                const checkedBoxes = document.querySelectorAll('.row-checkbox:checked');
                
                if (selectAllCheckbox) {
                    if (checkedBoxes.length === 0) {
                        selectAllCheckbox.checked = false;
                        selectAllCheckbox.indeterminate = false;
                    } else if (checkedBoxes.length === rowCheckboxes.length) {
                        selectAllCheckbox.checked = true;
                        selectAllCheckbox.indeterminate = false;
                    } else {
                        selectAllCheckbox.checked = false;
                        selectAllCheckbox.indeterminate = true;
                    }
                }
            }

            async function deleteSelectedSubmissions() {
                if (selectedSubmissions.size === 0) {
                    showToast('Vui lòng chọn ít nhất một mục để xóa', 'warning');
                    return;
                }

                const confirmMessage = `Bạn có chắc chắn muốn xóa ${selectedSubmissions.size} kết quả đã chọn?`;
                if (!confirm(confirmMessage)) return;
                
                showLoading(true);
                
                try {
                    const response = await fetch('/api/admin/submissions/bulk-delete', {
                        method: 'DELETE',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        credentials: 'same-origin',
                        body: JSON.stringify({
                            ids: Array.from(selectedSubmissions)
                        })
                    });
                      if (response.ok) {
                        const result = await response.json();
                        
                        // Remove deleted submissions from local array
                        submissions = submissions.filter(s => !selectedSubmissions.has(s._id));
                        
                        // Clear selection
                        selectedSubmissions.clear();
                        
                        // Re-render table
                        renderSubmissions();
                        
                        showToast(`Đã xóa thành công ${result.deletedCount} kết quả`, 'success');
                    } else {
                        // Check if response is JSON
                        const contentType = response.headers.get('content-type');
                        if (contentType && contentType.includes('application/json')) {
                            const error = await response.json();
                            showToast(error.message || error.error || 'Không thể xóa các kết quả đã chọn', 'error');
                        } else {
                            // Handle HTML error response (likely authentication error)
                            showToast('Lỗi xác thực. Vui lòng đăng nhập lại.', 'error');
                            setTimeout(() => {
                                window.location.href = '/';
                            }, 2000);
                        }
                    }
                } catch (error) {
                    console.error('Bulk delete error:', error);
                    showToast('Lỗi kết nối', 'error');
                }
                
                showLoading(false);
            }            async function handleExport() {
                // Prevent multiple simultaneous exports
                if (isExporting) {
                    showToast('Đang xuất file, vui lòng đợi...', 'warning');
                    return;
                }
                
                isExporting = true;
                showLoading(true);
                  try {
                    const queryParams = new URLSearchParams({
                        username: filters.username,
                        tdsName: filters.tdsName,
                        store: filters.store,
                        category: filters.category,
                        startDate: filters.startDate,
                        endDate: filters.endDate
                    });
                    
                    const response = await fetch('/api/admin/export?' + queryParams, {
                        credentials: 'same-origin'
                    });
                      if (response.ok) {
                        const blob = await response.blob();
                        const url = window.URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = `submissions_${new Date().toISOString().split('T')[0]}.xlsx`;
                        document.body.appendChild(a);
                        a.click();
                        document.body.removeChild(a);
                        window.URL.revokeObjectURL(url);
                        showToast('Xuất file thành công!', 'success');
                    } else {
                        // Handle different response types
                        let errorMessage = 'Xuất file thất bại';
                        try {
                            const contentType = response.headers.get('content-type');
                            if (contentType && contentType.includes('application/json')) {
                                const error = await response.json();
                                errorMessage = error.error || errorMessage;
                            } else {
                                if (response.status === 403) {
                                    errorMessage = 'Không có quyền truy cập';
                                } else if (response.status === 401) {
                                    errorMessage = 'Phiên làm việc đã hết hạn';
                                } else {
                                    errorMessage = `Lỗi server: ${response.status}`;
                                }
                            }
                        } catch (parseError) {
                            console.warn('Could not parse error response:', parseError);
                        }
                        showToast(errorMessage, 'error');
                    }
                } catch (error) {
                    console.error('Export error:', error);
                    showToast('Lỗi kết nối', 'error');
                } finally {
                    isExporting = false;
                    showLoading(false);
                }
            }            async function handleExportPptx() {
                // Prevent multiple simultaneous exports
                if (isExportingPptx) {
                    showToast('Đang xuất PowerPoint, vui lòng đợi...', 'warning');
                    return;
                }
                
                isExportingPptx = true;
                showLoading(true);
                
                try {
                    const queryParams = new URLSearchParams({
                        username: filters.username,
                        tdsName: filters.tdsName,
                        store: filters.store,
                        category: filters.category,
                        startDate: filters.startDate,
                        endDate: filters.endDate
                    });
                    
                    const response = await fetch('/api/admin/export-pptx?' + queryParams, {
                        credentials: 'same-origin'
                    });
                    
                    if (response.ok) {
                        const blob = await response.blob();
                        const url = window.URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = `submissions_${new Date().toISOString().split('T')[0]}.pptx`;
                        document.body.appendChild(a);
                        a.click();
                        document.body.removeChild(a);                        window.URL.revokeObjectURL(url);
                        showToast('Xuất PowerPoint thành công!', 'success');
                    } else {
                        // Handle different response types
                        let errorMessage = 'Xuất PowerPoint thất bại';
                        try {
                            const contentType = response.headers.get('content-type');
                            if (contentType && contentType.includes('application/json')) {
                                const error = await response.json();
                                errorMessage = error.error || errorMessage;
                            } else {
                                if (response.status === 403) {
                                    errorMessage = 'Không có quyền truy cập';
                                } else if (response.status === 401) {
                                    errorMessage = 'Phiên làm việc đã hết hạn';
                                } else {
                                    errorMessage = `Lỗi server: ${response.status}`;
                                }
                            }
                        } catch (parseError) {
                            console.warn('Could not parse error response:', parseError);
                        }
                        showToast(errorMessage, 'error');
                    }
                } catch (error) {
                    console.error('PowerPoint export error:', error);
                    showToast('Lỗi kết nối', 'error');
                } finally {
                    isExportingPptx = false;
                    showLoading(false);
                }
            }

            function applyFilters() {
                filters.username = filterUsername.value.trim();
                filters.tdsName = filterTdsName.value.trim();
                filters.store = filterStore.value.trim();
                filters.category = filterCategory.value.trim();
                filters.startDate = filterStartDate.value;
                filters.endDate = filterEndDate.value;
                
                currentPage = 1; // Reset to first page
                loadSubmissions();
            }
              function resetFilters() {
                filterUsername.value = '';
                filterTdsName.value = '';
                filterStore.value = '';
                filterCategory.value = '';
                filterStartDate.value = '';
                filterEndDate.value = '';
                
                filters = {
                    username: '',
                    tdsName: '',
                    store: '',
                    category: '',
                    startDate: '',
                    endDate: ''
                };
                  currentPage = 1;
                loadSubmissions();
                showToast('Đã xóa bộ lọc', 'success');
            }
            
            // Lightbox functions
            function openLightbox(images, startIndex = 0) {
                currentLightboxImages = images;
                currentLightboxIndex = startIndex;
                
                updateLightboxImage();
                updateLightboxControls();
                
                imageLightbox.style.display = 'block';
                document.body.style.overflow = 'hidden'; // Prevent background scrolling
            }
            
            function closeLightboxModal() {
                imageLightbox.style.display = 'none';
                document.body.style.overflow = ''; // Restore scrolling
                currentLightboxImages = [];
                currentLightboxIndex = 0;
            }
            
            function showPreviousImage() {
                if (currentLightboxImages.length <= 1) return;
                
                currentLightboxIndex = (currentLightboxIndex - 1 + currentLightboxImages.length) % currentLightboxImages.length;
                updateLightboxImage();
                updateLightboxControls();
            }
            
            function showNextImage() {
                if (currentLightboxImages.length <= 1) return;
                
                currentLightboxIndex = (currentLightboxIndex + 1) % currentLightboxImages.length;
                updateLightboxImage();
                updateLightboxControls();
            }
            
            function updateLightboxImage() {
                if (currentLightboxImages.length > 0) {
                    lightboxImage.src = currentLightboxImages[currentLightboxIndex];
                    
                    // Add loading effect
                    lightboxImage.style.opacity = '0';
                    lightboxImage.onload = () => {
                        lightboxImage.style.opacity = '1';
                    };
                }
            }
            
            function updateLightboxControls() {
                // Update counter
                currentImageIndex.textContent = currentLightboxIndex + 1;
                totalImages.textContent = currentLightboxImages.length;
                  // Show/hide navigation based on number of images
                if (currentLightboxImages.length <= 1) {
                    imageLightbox.classList.add('lightbox-single');
                } else {
                    imageLightbox.classList.remove('lightbox-single');
                }
            }

            // Template Management Functions
            function openTemplateModal() {
                templateModal.style.display = 'block';
                document.body.style.overflow = 'hidden';
            }
            
            function closeTemplateModalHandler() {
                templateModal.style.display = 'none';
                document.body.style.overflow = '';
                // Reset form states
                resetTemplateForm();
            }
            
            function switchTab(tabName) {
                // Update active tab button
                tabButtons.forEach(btn => {
                    btn.classList.toggle('active', btn.getAttribute('data-tab') === tabName);
                });
                
                // Update active tab content
                tabContents.forEach(content => {
                    content.classList.toggle('active', content.id === `${tabName}Tab`);
                });
            }
            
            function setupDropzone(dropzone, fileInput, type) {
                // Click to select file
                dropzone.addEventListener('click', () => {
                    fileInput.click();
                });
                
                // Drag and drop handlers
                dropzone.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    dropzone.classList.add('dragover');
                });
                
                dropzone.addEventListener('dragleave', (e) => {
                    e.preventDefault();
                    dropzone.classList.remove('dragover');
                });
                
                dropzone.addEventListener('drop', (e) => {
                    e.preventDefault();
                    dropzone.classList.remove('dragover');
                    
                    const files = e.dataTransfer.files;
                    if (files.length > 0) {
                        const file = files[0];
                        if (file.type === 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' || file.name.endsWith('.xlsx')) {
                            handleFileSelect({ target: { files: [file] } }, type);
                        } else {
                            showToast('Chỉ chấp nhận file Excel', 'error');
                        }
                    }
                });
            }
            
            function handleFileSelect(event, type) {
                const file = event.target.files[0];
                if (!file) return;
                
                if (file.type !== 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' && !file.name.endsWith('.xlsx')) {
                    showToast('Chỉ chấp nhận file Excel', 'error');
                    return;
                }
                
                if (type === 'stores') {
                    selectedStoresFile = file;
                    updateDropzoneDisplay(storesDropzone, file);
                    uploadStoresBtn.disabled = false;
                } else if (type === 'categories') {
                    selectedCategoriesFile = file;
                    updateDropzoneDisplay(categoriesDropzone, file);
                    uploadCategoriesBtn.disabled = false;
                }
            }
            
            function updateDropzoneDisplay(dropzone, file) {
                dropzone.innerHTML = `
                    <i class="fas fa-file-excel"></i>
                    <p><strong>${file.name}</strong></p>
                    <small>Kích thước: ${formatFileSize(file.size)}</small>
                `;
                dropzone.classList.add('file-selected');
            }
            
            function formatFileSize(bytes) {
                if (bytes === 0) return '0 Bytes';
                const k = 1024;
                const sizes = ['Bytes', 'KB', 'MB', 'GB'];
                const i = Math.floor(Math.log(bytes) / Math.log(k));
                return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
            }
            
            async function uploadTemplate(type) {
                const file = type === 'stores' ? selectedStoresFile : selectedCategoriesFile;
                if (!file) {
                    showToast('Vui lòng chọn file trước', 'error');
                    return;
                }
                  const formData = new FormData();
                const fieldName = type === 'stores' ? 'storesFile' : 'categoriesFile';
                formData.append(fieldName, file);
                
                // Show progress
                uploadProgress.style.display = 'block';
                progressText.textContent = 'Đang tải lên...';
                progressFill.style.width = '0%';
                
                // Disable upload button
                const uploadBtn = type === 'stores' ? uploadStoresBtn : uploadCategoriesBtn;
                uploadBtn.disabled = true;
                
                try {
                    const endpoint = type === 'stores' ? '/api/template/upload-stores' : '/api/template/upload-categories';
                    
                    const response = await fetch(endpoint, {
                        method: 'POST',
                        body: formData,
                        credentials: 'same-origin'
                    });
                    
                    // Simulate progress
                    let progress = 0;
                    const progressInterval = setInterval(() => {
                        progress += 10;
                        progressFill.style.width = `${Math.min(progress, 90)}%`;
                    }, 100);
                    
                    const result = await response.json();
                    
                    clearInterval(progressInterval);
                    progressFill.style.width = '100%';
                    
                    if (response.ok) {
                        progressText.textContent = 'Tải lên thành công!';
                        showToast(`Đã tải lên ${result.count} ${type === 'stores' ? 'cửa hàng' : 'danh mục'}`, 'success');
                        
                        // Reset form after successful upload
                        setTimeout(() => {
                            resetTemplateForm();
                            uploadProgress.style.display = 'none';
                        }, 2000);
                        
                        // Refresh data if needed
                        if (type === 'categories') {
                            loadSubmissions(); // Refresh to show updated categories
                        }
                    } else {
                        progressText.textContent = 'Tải lên thất bại!';
                        showToast(result.error || 'Lỗi tải lên file', 'error');
                        uploadBtn.disabled = false;
                    }
                } catch (error) {
                    console.error('Upload error:', error);
                    progressText.textContent = 'Lỗi kết nối!';
                    showToast('Lỗi kết nối', 'error');
                    uploadBtn.disabled = false;
                }
            }
            
            function resetTemplateForm() {
                // Reset file selections
                selectedStoresFile = null;
                selectedCategoriesFile = null;
                
                // Reset file inputs
                if (storesFileInput) storesFileInput.value = '';
                if (categoriesFileInput) categoriesFileInput.value = '';
                
                // Reset dropzones
                resetDropzone(storesDropzone, 'Kéo thả file Excel hoặc click để chọn');
                resetDropzone(categoriesDropzone, 'Kéo thả file Excel hoặc click để chọn');
                
                // Disable upload buttons
                if (uploadStoresBtn) uploadStoresBtn.disabled = true;
                if (uploadCategoriesBtn) uploadCategoriesBtn.disabled = true;
                
                // Hide progress
                if (uploadProgress) uploadProgress.style.display = 'none';
            }
            
            function resetDropzone(dropzone, text) {
                if (!dropzone) return;
                dropzone.innerHTML = `
                    <i class="fas fa-cloud-upload-alt"></i>
                    <p>${text}</p>
                    <small>Chỉ chấp nhận file .xlsx</small>                `;
                dropzone.classList.remove('file-selected', 'dragover');
            }

            // User Management Functions
            function openUserModal() {
                userModal.style.display = 'block';
                document.body.style.overflow = 'hidden';
                loadUsers();
            }
            
            function closeUserModalHandler() {
                userModal.style.display = 'none';
                document.body.style.overflow = '';
            }
            
            function openUserForm(user = null) {
                editingUserId = user ? user._id : null;
                
                if (user) {
                    // Edit mode
                    userFormTitle.innerHTML = '<i class="fas fa-user-edit"></i> Chỉnh sửa User';
                    document.getElementById('userUsername').value = user.username || '';
                    document.getElementById('userUserId').value = user.userId || '';
                    document.getElementById('userRole').value = user.role || '';
                    document.getElementById('userPassword').value = '';
                    document.getElementById('userPassword').placeholder = 'Bỏ trống nếu không muốn đổi mật khẩu';
                    document.getElementById('userPassword').required = false;
                    document.getElementById('userStatus').value = user.status || 'active';
                } else {
                    // Add mode
                    userFormTitle.innerHTML = '<i class="fas fa-user-plus"></i> Thêm User Mới';
                    userForm.reset();
                    document.getElementById('userPassword').placeholder = '';
                    document.getElementById('userPassword').required = true;
                }
                
                userFormModal.style.display = 'block';
                document.body.style.overflow = 'hidden';
            }
            
            function closeUserFormModalHandler() {
                userFormModal.style.display = 'none';
                document.body.style.overflow = '';
                userForm.reset();
                editingUserId = null;
            }
            
            async function loadUsers() {
                showLoading(true);
                
                try {
                    const response = await fetch('/api/admin/users', {
                        credentials: 'same-origin'
                    });
                    
                    if (response.ok) {
                        users = await response.json();
                        renderUsers();
                        showToast('Đã tải danh sách user', 'success');
                    } else {
                        showToast('Không thể tải danh sách user', 'error');
                    }
                } catch (error) {
                    console.error('Load users error:', error);
                    showToast('Lỗi kết nối', 'error');
                }
                
                showLoading(false);
            }
            
            function renderUsers() {
                usersTableBody.innerHTML = '';
                
                if (users.length === 0) {
                    usersTableBody.innerHTML = `
                        <tr>
                            <td colspan="6" style="text-align: center; padding: 30px;">
                                <i class="fas fa-info-circle"></i> Không có user nào
                            </td>
                        </tr>
                    `;
                    return;
                }
                
                users.forEach(user => {
                    const createdDate = user.createdAt ? new Date(user.createdAt).toLocaleDateString('vi-VN') : 'N/A';
                    const statusClass = user.status === 'active' ? 'status-active' : 'status-inactive';
                    const statusText = user.status === 'active' ? 'Hoạt động' : 'Không hoạt động';
                    
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${user.username || 'N/A'}</td>
                        <td>${user.userId || 'N/A'}</td>
                        <td>${user.role || 'N/A'}</td>
                        <td><span class="status-badge ${statusClass}">${statusText}</span></td>
                        <td>${createdDate}</td>
                        <td class="actions">
                            <button class="btn-action btn-edit" data-user='${JSON.stringify(user)}' title="Chỉnh sửa">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn-action btn-toggle-status" data-id="${user._id}" data-status="${user.status}" title="Thay đổi trạng thái">
                                <i class="fas fa-${user.status === 'active' ? 'pause' : 'play'}"></i>
                            </button>
                            <button class="btn-action btn-reset-password" data-id="${user._id}" title="Đặt lại mật khẩu">
                                <i class="fas fa-key"></i>
                            </button>
                            ${user.username !== 'admin' ? `
                                <button class="btn-action btn-delete-user" data-id="${user._id}" title="Xóa user">
                                    <i class="fas fa-trash"></i>
                                </button>
                            ` : ''}
                        </td>
                    `;
                    
                    usersTableBody.appendChild(row);
                });
                
                // Add event listeners
                document.querySelectorAll('.btn-edit').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const user = JSON.parse(btn.getAttribute('data-user'));
                        openUserForm(user);
                    });
                });
                
                document.querySelectorAll('.btn-toggle-status').forEach(btn => {
                    btn.addEventListener('click', () => toggleUserStatus(btn.getAttribute('data-id')));
                });
                
                document.querySelectorAll('.btn-reset-password').forEach(btn => {
                    btn.addEventListener('click', () => resetUserPassword(btn.getAttribute('data-id')));
                });
                
                document.querySelectorAll('.btn-delete-user').forEach(btn => {
                    btn.addEventListener('click', () => deleteUser(btn.getAttribute('data-id')));
                });
            }
            
            async function handleUserFormSubmit(e) {
                e.preventDefault();
                showLoading(true);
                
                const formData = new FormData(userForm);
                const userData = {
                    username: formData.get('username'),
                    userId: formData.get('userId'),
                    tdsName: formData.get('tdsName'),
                    password: formData.get('password'),
                    status: formData.get('status')
                };
                
                // Remove empty password for edit mode
                if (editingUserId && !userData.password) {
                    delete userData.password;
                }
                
                try {
                    const url = editingUserId ? `/api/admin/users/${editingUserId}` : '/api/admin/users';
                    const method = editingUserId ? 'PUT' : 'POST';
                    
                    const response = await fetch(url, {
                        method: method,
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(userData),
                        credentials: 'same-origin'
                    });
                    
                    const result = await response.json();
                    
                    if (response.ok) {
                        showToast(editingUserId ? 'Đã cập nhật user' : 'Đã tạo user mới', 'success');
                        closeUserFormModalHandler();
                        loadUsers();
                    } else {
                        showToast(result.error || 'Lỗi xử lý', 'error');
                    }
                } catch (error) {
                    console.error('User form error:', error);
                    showToast('Lỗi kết nối', 'error');
                }
                
                showLoading(false);
            }
            
            async function toggleUserStatus(userId) {
                const user = users.find(u => u._id === userId);
                const currentStatus = user ? user.status : 'active';
                const newStatus = currentStatus === 'active' ? 'vô hiệu hóa' : 'kích hoạt';
                
                if (!confirm(`Bạn có chắc chắn muốn ${newStatus} user này?`)) return;
                
                showLoading(true);
                
                try {
                    const response = await fetch(`/api/admin/users/${userId}/toggle-status`, {
                        method: 'POST',
                        credentials: 'same-origin'
                    });
                    
                    if (response.ok) {
                        showToast(`Đã ${newStatus} user`, 'success');
                        loadUsers();
                    } else {
                        const result = await response.json();
                        showToast(result.error || 'Không thể thay đổi trạng thái', 'error');
                    }
                } catch (error) {
                    console.error('Toggle status error:', error);
                    showToast('Lỗi kết nối', 'error');
                }
                
                showLoading(false);
            }
            
            async function resetUserPassword(userId) {
                const newPassword = prompt('Nhập mật khẩu mới:');
                if (!newPassword || newPassword.trim().length < 3) {
                    showToast('Mật khẩu phải có ít nhất 3 ký tự', 'error');
                    return;
                }
                
                showLoading(true);
                
                try {
                    const response = await fetch(`/api/admin/users/${userId}/reset-password`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ newPassword: newPassword.trim() }),
                        credentials: 'same-origin'
                    });
                    
                    if (response.ok) {
                        showToast('Đã đặt lại mật khẩu', 'success');
                    } else {
                        const result = await response.json();
                        showToast(result.error || 'Không thể đặt lại mật khẩu', 'error');
                    }
                } catch (error) {
                    console.error('Reset password error:', error);
                    showToast('Lỗi kết nối', 'error');
                }
                
                showLoading(false);
            }
            
            async function deleteUser(userId) {
                if (!confirm('Bạn có chắc chắn muốn xóa user này? Hành động này không thể hoàn tác.')) return;
                
                showLoading(true);
                
                try {
                    const response = await fetch(`/api/admin/users/${userId}`, {
                        method: 'DELETE',
                        credentials: 'same-origin'
                    });
                    
                    if (response.ok) {
                        showToast('Đã xóa user', 'success');
                        loadUsers();
                    } else {
                        const result = await response.json();
                        showToast(result.error || 'Không thể xóa user', 'error');
                    }
                } catch (error) {
                    console.error('Delete user error:', error);
                    showToast('Lỗi kết nối', 'error');
                }
                
                showLoading(false);
            }
        });    </script>
</body>
</html>
